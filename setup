#!/bin/bash

set -euo pipefail

###############################################################################
# setup
# Purpose: orchestrate local setup steps (install deps, fonts, brew, stow)
###############################################################################

ROOT_DIR="$(cd "$(dirname "$0")" && pwd)"
SCRIPTS_DIR="$ROOT_DIR/scripts"

cd "$SCRIPTS_DIR"

###############################################################################
# Step runner
###############################################################################
run_step() {
	local script="$1"
	echo "Running $script..."
	bash "$script"
}

###############################################################################
# Install essential dependencies (scripts)
###############################################################################
run_step install_dependencies.sh
run_step install_nerdfonts.sh
run_step install_brew.sh

###############################################################################
# Homebrew environment (if present)
###############################################################################
if [[ -x /home/linuxbrew/.linuxbrew/bin/brew ]]; then
	eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi

###############################################################################
# Homebrew package installation (idempotent)
###############################################################################
if command -v brew >/dev/null 2>&1; then
	# Define packages in one place for readability and easier maintenance
	PACKAGES=(
		rust
		neovim
		fd
		fzf
		ripgrep
		lazygit
		node
		pyright
		uv
		eza
		starship
		tmux
		yazi
		zoxide
	)

	echo "Installing Homebrew packages: ${PACKAGES[*]}"
	for pkg in "${PACKAGES[@]}"; do
		# Skip if already installed (formula or cask)
		if ! brew list --formula | grep -q "^${pkg}$" && ! brew list --cask | grep -q "^${pkg}$"; then
			echo "- installing $pkg"
			brew install "$pkg" || echo "Warning: failed to install $pkg"
		else
			echo "- $pkg already installed, skipping"
		fi
	done
else
	echo "Homebrew is not available; skipping brew package installation steps."
fi

###############################################################################
# Personal configuration (git, stow)
###############################################################################
run_step setup_gitconfig.sh
run_step backup_and_stow.sh
